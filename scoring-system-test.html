<!DOCTYPE html>
<html>
<head>
    <title>Scoring System Validation</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .result { font-weight: bold; margin: 10px 0; }
        .pass { color: green; }
        .fail { color: red; }
        .breakdown { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>Assessment Scoring System Validation</h1>
    <p>Testing the updated 21-question, 6-category scoring system with "Don't Know" handling</p>
    
    <div id="testResults"></div>

    <script>
        // Updated categories structure matching production system
        const categories = [
            {
                name: "Risk of Change of Ownership",
                weight: 0.3,
                questions: [
                    { text: "Can your business operate profitably for 30+ days without you being present?", weight: 0.4 },
                    { text: "Are all critical business processes documented so someone else could follow them?", weight: 0.25 },
                    { text: "Do you have at least one key employee who could manage daily operations?", weight: 0.2 },
                    { text: "Are your key customer relationships maintained by employees other than yourself?", weight: 0.15 }
                ]
            },
            {
                name: "Company Growth",
                weight: 0.2,
                questions: [
                    { text: "Has your business grown revenue in the past 12 months?", weight: 0.45 },
                    { text: "Has your revenue increased in at least 3 of the last 4 years?", weight: 0.35 },
                    { text: "Do you regularly win new customers each month?", weight: 0.2 }
                ]
            },
            {
                name: "Industry Growth",
                weight: 0.15,
                questions: [
                    { text: "Is demand for your type of business generally increasing?", weight: 0.5 },
                    { text: "Would it cost a new competitor more than $50000 to start competing with you?", weight: 0.3 },
                    { text: "Is your business resistant to being replaced by technology or automation?", weight: 0.2 }
                ]
            },
            {
                name: "Market Demand",
                weight: 0.15,
                questions: [
                    { text: "Do you have repeat customers or predictable revenue streams?", weight: 0.4 },
                    { text: "Do you keep more than 10 cents profit from every dollar of revenue?", weight: 0.35 },
                    { text: "Is your business type generally attractive to buyers in your area?", weight: 0.25 }
                ]
            },
            {
                name: "Company Rating",
                weight: 0.1,
                questions: [
                    { text: "Are your financial records prepared by a bookkeeper or accountant?", weight: 0.3 },
                    { text: "Do you keep business and personal expenses completely separate?", weight: 0.25 },
                    { text: "Does your largest customer represent less than 20% of your total revenue?", weight: 0.25 },
                    { text: "Do you have written contracts or agreements with your key customers?", weight: 0.2 }
                ]
            },
            {
                name: "Competitiveness",
                weight: 0.1,
                questions: [
                    { text: "Do customers choose you over competitors at least 50% of the time?", weight: 0.35 },
                    { text: "Can you charge similar or higher prices than your main competitors?", weight: 0.3 },
                    { text: "Do you have positive online reviews or strong customer references?", weight: 0.25 },
                    { text: "Do potential customers contact you directly without heavy marketing?", weight: 0.1 }
                ]
            }
        ];

        function calculateScore(answers) {
            let totalScore = 0;
            let breakdown = [];
            
            categories.forEach((category, catIndex) => {
                let categoryScore = 0;
                let categoryDetails = {
                    name: category.name,
                    weight: category.weight,
                    rawScore: 0,
                    weightedScore: 0
                };
                
                category.questions.forEach((question, qIndex) => {
                    const answer = answers.find(a => 
                        a.category === catIndex && a.question === qIndex
                    );
                    
                    if (answer && answer.answer === true) {
                        categoryScore += question.weight;
                    } else if (answer && answer.answer === null) {
                        categoryScore += question.weight * 0.15; // 15% for "Don't Know"
                    }
                    // No points for false answers (0%)
                });
                
                categoryDetails.rawScore = categoryScore;
                categoryDetails.weightedScore = categoryScore * category.weight;
                totalScore += categoryDetails.weightedScore;
                breakdown.push(categoryDetails);
            });
            
            return {
                finalScore: Math.round(totalScore * 100),
                categoryBreakdown: breakdown
            };
        }

        function generateAnswers(answerType) {
            const answers = [];
            categories.forEach((category, catIndex) => {
                category.questions.forEach((question, qIndex) => {
                    answers.push({ 
                        category: catIndex, 
                        question: qIndex, 
                        answer: answerType === 'yes' ? true : 
                               answerType === 'no' ? false : null 
                    });
                });
            });
            return answers;
        }

        // Test scenarios
        const testScenarios = [
            {
                name: "Perfect Score Test",
                answers: generateAnswers('yes'),
                expectedScore: 100,
                description: "All questions answered 'Yes' should yield 100%"
            },
            {
                name: "Zero Score Test", 
                answers: generateAnswers('no'),
                expectedScore: 0,
                description: "All questions answered 'No' should yield 0%"
            },
            {
                name: "Don't Know Penalty Test",
                answers: generateAnswers('dont_know'), 
                expectedScore: 15,
                description: "All 'Don't Know' answers should yield 15%"
            }
        ];

        function validateSystem() {
            // Verify structural integrity
            const totalCategoryWeight = categories.reduce((sum, cat) => sum + cat.weight, 0);
            const totalQuestions = categories.reduce((sum, cat) => sum + cat.questions.length, 0);
            
            let validationResults = `
                <div class="breakdown">
                    <h3>System Validation</h3>
                    <strong>Structure:</strong><br>
                    Total Questions: ${totalQuestions}<br>
                    Total Categories: ${categories.length}<br>
                    Category Weights Sum: ${totalCategoryWeight.toFixed(3)} ${totalCategoryWeight === 1.0 ? '✅' : '❌'}<br><br>
                    
                    <strong>Category Structure:</strong><br>
            `;
            
            categories.forEach((cat, index) => {
                const questionWeightSum = cat.questions.reduce((sum, q) => sum + q.weight, 0);
                validationResults += `${index + 1}. ${cat.name}: ${cat.questions.length} questions, ${Math.round(cat.weight * 100)}% weight, question weights: ${questionWeightSum.toFixed(3)} ${Math.abs(questionWeightSum - 1.0) < 0.001 ? '✅' : '❌'}<br>`;
            });
            
            validationResults += `</div>`;
            
            // Test scoring scenarios
            testScenarios.forEach(scenario => {
                const result = calculateScore(scenario.answers);
                const passed = Math.abs(result.finalScore - scenario.expectedScore) <= 1;
                
                validationResults += `
                    <div class="test-case">
                        <h3>${scenario.name}</h3>
                        <p>${scenario.description}</p>
                        <div class="result ${passed ? 'pass' : 'fail'}">
                            Expected: ${scenario.expectedScore}% | Actual: ${result.finalScore}% 
                            ${passed ? '✅ PASS' : '❌ FAIL'}
                        </div>
                        <div class="breakdown">
                            <strong>Category Breakdown:</strong><br>
                            ${result.categoryBreakdown.map(cat => 
                                `${cat.name}: ${Math.round(cat.rawScore * 100)}% raw → ${Math.round(cat.weightedScore * 100)}% weighted`
                            ).join('<br>')}
                        </div>
                    </div>
                `;
            });

            document.getElementById('testResults').innerHTML = validationResults;
        }

        // Execute validation
        validateSystem();
    </script>
</body>
</html>